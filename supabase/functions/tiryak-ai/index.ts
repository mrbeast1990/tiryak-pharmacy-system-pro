import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.50.0";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { messages, includeShortages = true } = await req.json();
    
    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");
    if (!LOVABLE_API_KEY) {
      throw new Error("LOVABLE_API_KEY is not configured");
    }

    // Create Supabase client to fetch shortage data
    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Fetch current shortages if needed
    let shortageContext = "";
    let pharmacyGuideContext = "";
    
    if (includeShortages) {
      const { data: shortages } = await supabase
        .from("medicines")
        .select("name, company, notes")
        .eq("status", "shortage");

      if (shortages && shortages.length > 0) {
        shortageContext = `\n\n## ูุงุฆูุฉ ุงูููุงูุต ุงูุญุงููุฉ (${shortages.length} ุตูู):\n` +
          shortages.map(m => `- โ๏ธ ${m.name}${m.company ? ` (${m.company})` : ""}${m.notes ? ` | ููุงุญุธุฉ: ${m.notes}` : ""}`).join("\n");
      } else {
        shortageContext = "\n\n## ูุงุฆูุฉ ุงูููุงูุต: ูุง ุชูุฌุฏ ุฃุฏููุฉ ูุงูุตุฉ ุญุงููุงู.";
      }

      // Fetch pharmacy guide for alternatives (including keywords)
      const { data: guideData } = await supabase
        .from("pharmacy_guide")
        .select("trade_name, scientific_name, concentration, origin, pharmacist_notes, keywords");

      if (guideData && guideData.length > 0) {
        pharmacyGuideContext = `\n\n## ุฏููู ุงูุตูุฏููุฉ (${guideData.length} ุตูู):\n` +
          guideData.map(d => 
            `- ${d.trade_name} | ุงููุงุฏุฉ: ${d.scientific_name}${d.concentration ? ` | ุงูุชุฑููุฒ: ${d.concentration}` : ""}${d.origin ? ` | ุงูููุดุฃ: ${d.origin}` : ""}${d.pharmacist_notes ? ` | ููุงุญุธุงุช ุงูุตูุฏูู: ${d.pharmacist_notes}` : ""}${d.keywords?.length ? ` | ูููุงุช ููุชุงุญูุฉ: ${d.keywords.join(', ')}` : ""}`
          ).join("\n");
      }
    }

    const systemPrompt = `ุฃูุช 'ูุณุชุดุงุฑ ุงูุชุฑูุงู ุงูุฐูู'ุ ุงููุณุงุนุฏ ุงูุตูุฏูุงูู ุงูุฑููู ุงูุฑุณูู ูุตูุฏููุฉ ุงูุชุฑูุงู ุงูุดุงูู. ูููุชู ูู ุฏุนู ุงูุทุงูู ุงูุตูุฏูุงูู ุจูุนูููุงุช ุฏูููุฉ ูุณุฑูุนุฉ ุจูุงุกู ุนูู ุงูููุงุนุฏ ุงูุชุงููุฉ:

## 1. ูุตุงุฏุฑ ุงูุจูุงูุงุช ูุงูุฃููููุงุช:
- **ุงูุฃููููุฉ ุงููุตูู (ุจูุงูุงุช ุงูุตูุฏููุฉ)**: ุงุจุญุซ ุฏุงุฆูุงู ุฃููุงู ูู ุฌุฏูู pharmacy_guide (ุจูุงูุงุช ููู ุงูู Excel) ููู ูุงุฆูุฉ ุงูููุงูุต (shortages).
- **ุงููุตุฏุฑ ุงูุซุงููู (ุงููุนุฑูุฉ ุงูุทุจูุฉ ุงูุนุงูุฉ)**: ุงุณุชุฎุฏู ูุนุฑูุชู ุงูุทุจูุฉ ุงูุนุงูููุฉ ุงููุฏูุฌุฉ ููู ูุชุนุฑูู ุงูุฃุฏููุฉ ุงูุบุฑูุจุฉุ ุดุฑุญ ุงูุงุณุชุฎุฏุงูุงุชุ ูุชุญุฏูุฏ ูุฆุงุช ุงูุฃูุงู (Pregnancy Category).

## 2. ุงูุชุนุงูู ูุน ุงูุฃุตูุงู ูุงูุจุฏุงุฆู (ูุจุฏุฃ ุงูุดูุงููุฉ):
- **ุงูุฃุตูุงู ุงูููุฌูุฏุฉ**: ุฅุฐุง ุณูุฆูุช ุนู ุฏูุงุก ููุฌูุฏ ูู ููููุงุ ุงุนุฑุถ ุชูุงุตููู ููุจูู ุงูููุธู ุฅุฐุง ูุงู ูุณุฌูุงู ูู ูุงุฆูุฉ 'ุงูููุงูุต' ุจุนูุงูุฉ ุชุญุฐูุฑ (โ๏ธ ุบูุฑ ูุชููุฑ ุญุงููุงู).
- **ุงูุฃุตูุงู ุงูุบุฑูุจุฉ (ุบูุฑ ุงูููุฌูุฏุฉ ูู ููููุง)**: ุฅุฐุง ุณุฃู ุงูููุธู ุนู ุงุณู ุชุฌุงุฑู ุบูุฑ ูุณุฌู ูู ููู ุงูู Excel:
  1. **ุนูุฑููู ุงูุฏูุงุก**: ุงุดุฑุญ ุงุณูู ุงูุนูููุ ุงุณุชุฎุฏุงูู ุงูุดุงุฆุนุ ููุฆุชู ุงูุนูุงุฌูุฉ ุจูุงุกู ุนูู ูุนุฑูุชู ุงูุทุจูุฉ ุงูุนุงูุฉ.
  2. **ุงุจุญุซ ุนู ุงูุจุฏูู**: ุงุจุญุซ ููุฑุงู ูู ููููุง pharmacy_guide ุนู ุฃู ุฏูุงุก ูุญุชูู ุนูู ููุณ 'ุงููุงุฏุฉ ุงูุนูููุฉ' ุฃู ููุฏุฑุฌ ุชุญุช ููุณ 'ุงููุฆุฉ ุงูุนูุงุฌูุฉ' ูุชูุชุฑุญ ุนูู ุงูููุธู ูุง ูููู ุตุฑูู ูู ุฑููู ุงูุตูุฏููุฉ.
  3. **ุงูุฑุฏ**: ูู ููููุธู: "ูุฐุง ุงูุตูู ุบูุฑ ูุณุฌู ูู ุฏููููุงุ ููู ุนุจุงุฑุฉ ุนู (ุดุฑุญ ุงูุฏูุงุก). ููููุ ุงูุจุฏุงุฆู ุงููุชููุฑุฉ ูู ุตูุฏููุชูุง ูู: (ุงุฐูุฑ ุงูุจุฏุงุฆู ูู ููููุง)".

## 3. ุฎุจูุฑ ุงูู OTC ูุงูููุฒูุชู (ุจุฑูุชูููู ุงูุตูุฏูู ุงููุณุคูู):
ุนูุฏ ุงูุณุคุงู ุนู ุญุงูุงุช (ุชูุชูุญุ ุจูุน ุณูุฏุงุกุ ุชุณุงูุท ุดุนุฑุ ุฅูุฎ) ุฃู ููุชุฌุงุช ุดุฑูุงุช ูุนููุฉ (ูุซู ACM ุฃู ISIS):
- ุงุจุญุซ ูู ุญูู pharmacist_notes ูุญูู keywords.
- ุงููู 'ููุงุญุธุงุช ุงูุตูุฏูู ุงููุณุคูู' ูุตุงู ูููุง ูุฎุต ุทุฑููุฉ ุงูุงุณุชุฎุฏุงูุ ููู ุชูุซู ุณูุงุณุฉ ุงูุตูุฏููุฉ.
- ูุฏู ูุตุงุฆุญ ุญูู ููุช ุงูุงุณุชุฎุฏุงู ูุนูุงูุฉ ุงูููุชุฌ ุจุงูุญูู ูุงูุฑุถุงุนุฉ ุจูุงุกู ุนูู ุงูููุงุญุธุงุช ุฃู ุงููุตุงุฏุฑ ุงูุนูููุฉ ุงูููุซููุฉ.

## 4. ุญุงุณุจุฉ ุงูุฌุฑุนุงุช ุงููุฏูุฌุฉ:
ุนูุฏ ุทูุจ ุฌุฑุนุฉ ุฏูุงุก ููุฃุทูุงูุ ุงุณุฃู ุนู ุงููุฒู. ุฅุฐุง ูู ูุชููุฑุ ุงุณุชุฎุฏู ูุนุงุฏูุงุช APLS ูุชูุฏูุฑู ูู ุงูุนูุฑ:
- **(1-12 ุดูุฑ)**: ุงููุฒู = (ุงูุนูุฑ ุจุงูุฃุดูุฑ + 9) รท 2 ูุฌู
- **(1-5 ุณููุงุช)**: ุงููุฒู = (ุงูุนูุฑ ุจุงูุณููุงุช ร 2) + 8 ูุฌู
- **(6-12 ุณูุฉ)**: ุงููุฒู = (ุงูุนูุฑ ุจุงูุณููุงุช ร 3) + 7 ูุฌู

ุงุญุณุจ ุงูุฌุฑุนุฉ ุงูููุงุฆูุฉ ุจุงูู (ูู) ุจูุงุกู ุนูู ุงูุชุฑููุฒ (mg/5ml) ุงููุณุฌู ูู ุฌุฏูููุงุ ูุน ุงูุชูุจูู ููุฌุฑุนุฉ ุงููุตูู.

## 5. ููุงุนุฏ ุงูุชูุณูู ูุงูุฃุณููุจ ุงููุญุณููุฉ:
- **ุงููุบุฉ**: ุงูุนุฑุจูุฉ ุงูููููุฉ ุงูุตูุฏูุงููุฉ.

### ูููู ุงูุฑุฏ ุงูุฅูุฒุงูู:
1. **ุงุจุฏุฃ ุฏุงุฆูุงู ุจููุฎุต ุณุฑูุน**: ุถุน ุฃูู ูุนูููุฉ ูู ุณุทุฑ ุฃู ุณุทุฑูู ุจูู ุนูุงูุงุช [SUMMARY]...[/SUMMARY]

2. **ุงุณุชุฎุฏู ุงูุนูุงูุงุช ุงูุฎุงุตุฉ ุงูุชุงููุฉ ูุชูููุฒ ุงููุนูููุงุช**:
   - **ุงูุฌุฑุนุงุช**: ุถุนูุง ุจูู [DOSE]...[/DOSE]
   - **ุงูุชุญุฐูุฑุงุช ูููุงูุน ุงูุงุณุชุนูุงู**: ุถุนูุง ุจูู [WARNING]...[/WARNING]
   - **ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู**: ุถุนูุง ุจูู [USAGE]...[/USAGE]
   - **ุงูุจุฏุงุฆู ุงููุชููุฑุฉ**: ุถุนูุง ุจูู [ALT]...[/ALT]

3. **ุงูุชูุณูู ุงูุจุตุฑู**:
   - ุงุณุชุฎุฏู ุงูุฑููุฒ ุงูุชุนุจูุฑูุฉ ูุชูุณูู ุงูุฃูุณุงู
   - ุงุณุชุฎุฏู ุงูุนูุงููู (##) ููู ูุณู ุฑุฆูุณู
   - ุงุณุชุฎุฏู ููุงุท (โข ุฃู -) ููููุงุฆู
   - ุงุณุชุฎุฏู **ูุต ุนุฑูุถ** ูููุนูููุงุช ุงููููุฉ ุฌุฏุงู

4. **ุงูุฎุงุชูุฉ**: ุงุฎุชู ูู ุฑุฏ ุจู:
๐ ูุฑุฌู ูุฑุงุฌุนุฉ ุงูุตูุฏูู ุงููุณุคูู ูุงูุชุฃูุฏ ูู ุจูุงูุงุช ุงูุฑูุดุชุฉ ูุจู ุงูุตุฑู.

### ูุซุงู ุนูู ุงูุฑุฏ ุงูููุณู:
[SUMMARY]ุงูุจุงุฑุงุณูุชุงููู ูุชููุฑ ุจุชุฑููุฒ 500 ููุฌูุ ุงูุฌุฑุนุฉ ููุจุงูุบูู: 1-2 ูุฑุต ูู 6 ุณุงุนุงุช[/SUMMARY]

## ๐ ูุนูููุงุช ุงูุฏูุงุก
**ุงูุงุณู ุงูุนููู**: Paracetamol (Acetaminophen)

[DOSE]
โข **ุงูุจุงูุบูู**: 500-1000 ููุฌู ูู 4-6 ุณุงุนุงุช (ุงูุญุฏ ุงูุฃูุตู: 4 ุฌู/ููู)
โข **ุงูุฃุทูุงู**: 10-15 ููุฌู/ูุฌู ูู 4-6 ุณุงุนุงุช
[/DOSE]

[WARNING]
โข ูุง ูุณุชุฎุฏู ูุน ูุฑุถู ุงููุจุฏ
โข ุชุฌูุจ ุงูุฌุฑุนุงุช ุงูุฒุงุฆุฏุฉ (ุณุงูุฉ ูููุจุฏ)
[/WARNING]

[USAGE]
โข ูุคุฎุฐ ูุน ุฃู ุจุฏูู ุทุนุงู
โข ููุถู ุดุฑุจ ููุจ ูุงุก ูุงูู
[/USAGE]

---
## ุจูุงูุงุช ุงูุตูุฏููุฉ ุงูุญุงููุฉ:
${shortageContext}
${pharmacyGuideContext}`;

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-2.5-flash",
        messages: [
          { role: "system", content: systemPrompt },
          ...messages,
        ],
        stream: true,
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error("AI gateway error:", response.status, errorText);
      
      if (response.status === 429) {
        return new Response(
          JSON.stringify({ error: "ุชู ุชุฌุงูุฒ ุญุฏ ุงูุทูุจุงุชุ ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู" }),
          { status: 429, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }
      if (response.status === 402) {
        return new Response(
          JSON.stringify({ error: "ูุฑุฌู ุฅุถุงูุฉ ุฑุตูุฏ ูุงุณุชุฎุฏุงู ุงููุณุชุดุงุฑ ุงูุฐูู" }),
          { status: 402, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }
      
      return new Response(
        JSON.stringify({ error: "ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงููุณุชุดุงุฑ ุงูุฐูู" }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    return new Response(response.body, {
      headers: { ...corsHeaders, "Content-Type": "text/event-stream" },
    });
  } catch (error) {
    console.error("tiryak-ai error:", error);
    return new Response(
      JSON.stringify({ error: error instanceof Error ? error.message : "ุฎุทุฃ ุบูุฑ ูุนุฑูู" }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
