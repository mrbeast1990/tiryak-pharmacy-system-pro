
# خطة التحسينات الشاملة

## نظرة عامة
هذه الخطة تتضمن 6 تحسينات رئيسية على النظام:

1. جعل الاسم العلمي إجبارياً عند تسجيل النواقص
2. إضافة بحث في قائمة الشركات عند تسجيل السدادات
3. تعديل فلاتر السدادات (إلغاء اليوم/الأسبوع، الشهر = شهر كامل محدد)
4. نظام صفحات للسدادات (كل 50 سداد صفحة)
5. بطاقة خاصة لكل شركة بسداداتها
6. إعادة بناء البوت التحليلي بالكامل مع جلسات محفوظة

---

## 1. الاسم العلمي إجباري

### الملف: `src/components/shortage/AddMedicineDialog.tsx`

**التغييرات:**
- تغيير عنوان الحقل من "الاسم العلمي (اختياري)" الى "الاسم العلمي"
- إضافة علامة النجمة الحمراء للدلالة على الإجبارية
- إضافة تحقق (validation) في `handleSubmit` يمنع الإرسال بدون الاسم العلمي
- عرض رسالة خطأ "يرجى إدخال الاسم العلمي" عند المحاولة بدون إدخاله

---

## 2. بحث في قائمة الشركات

### الملف: `src/components/payments/CompanySelector.tsx`

**التغييرات:**
- استبدال `Select` بمكون `Popover` + `Command` (cmdk) لتوفير حقل بحث داخل القائمة
- عند النقر يظهر حقل بحث في أعلى القائمة
- الشركات تُفلتر أثناء الكتابة بالاسم أو اسم المندوب
- يبقى زر إضافة شركة جديدة وزر التعديل كما هو

---

## 3. تعديل فلاتر السدادات

### الملف: `src/components/payments/PaymentsFilters.tsx`

**التغييرات:**
- إزالة خيارات "اليوم" و "الأسبوع"
- تغيير "الشهر" ليصبح قائمة منسدلة لاختيار شهر محدد (شهر 1، شهر 2، ... شهر 12) مع السنة
- إبقاء خيار "الكل" و"غير المخصومة فقط" وفلتر الشركة

### الملف: `src/store/paymentsStore.ts`

**التغييرات:**
- تعديل نوع `dateFilter` من `'all' | 'today' | 'week' | 'month'` إلى `'all' | 'month'`
- إضافة `selectedMonth` (رقم الشهر 1-12) و `selectedYear` للفلاتر
- تعديل `getFilteredPayments` للفلترة بالشهر والسنة المحددين

---

## 4. نظام صفحات للسدادات

### الملف: `src/components/payments/PaymentsList.tsx`

**التغييرات:**
- إضافة state للصفحة الحالية `currentPage`
- عرض 50 سداد فقط لكل صفحة
- إضافة أزرار التنقل بين الصفحات (السابق / التالي / رقم الصفحة) في الأسفل
- عرض عدد الصفحات والصفحة الحالية

---

## 5. بطاقة خاصة لكل شركة

### الملف: `src/components/payments/PaymentsManager.tsx` + ملف جديد `src/components/payments/CompanyDetailsView.tsx`

**المفهوم:**
- عند النقر على اسم شركة (من فلتر الشركات أو من بطاقة سداد) تفتح صفحة/عرض تفصيلي للشركة
- يعرض: بيانات الشركة (اسم، مندوب، هاتف، حساب بنكي)
- إجمالي سدادات الشركة، المخصوم وغير المخصوم
- قائمة جميع سدادات هذه الشركة

### ملف جديد: `src/components/payments/CompanyDetailsView.tsx`

**المحتوى:**
- Header يعرض اسم الشركة ومعلوماتها
- بطاقات ملخص (إجمالي السدادات، غير المخصوم)
- قائمة السدادات الخاصة بها مع نظام صفحات
- زر رجوع

### تعديل `PaymentsFilters.tsx`:
- تحويل فلتر الشركة من Select الى أزرار/بطاقات قابلة للنقر
- عند النقر على شركة يتم عرض CompanyDetailsView

---

## 6. إعادة بناء البوت التحليلي بالكامل

### أ. الملف: `src/components/AdminAIAssistant.tsx` (إعادة بناء كامل)

**التصميم الجديد:**

```text
+------------------------------------------+
|  مساعد الترياق التحليلي          [رجوع]  |
+------------------------------------------+
|  [+ محادثة جديدة]                        |
|  ┌──────────────────────────────────────┐ |
|  │ محادثة: تحليل إيرادات شهر 1    [حذف]│ |
|  │ محادثة: نواقص متكررة           [حذف]│ |
|  │ محادثة: مقارنة مصاريف          [حذف]│ |
|  └──────────────────────────────────────┘ |
|                                           |
|  === منطقة الشات ===                      |
|  [رسائل المحادثة المحددة]                 |
|                                           |
|  [اكتب رسالتك...]              [إرسال]   |
+------------------------------------------+
```

**المزايا:**
- استخدام hook `useAIConversations` الموجود بالفعل لحفظ الجلسات
- عرض قائمة الجلسات السابقة في أعلى الشات
- إمكانية التنقل بين الجلسات وحذفها
- زر "محادثة جديدة" لبدء جلسة فارغة
- حفظ كل رسالة في قاعدة البيانات (جدول ai_messages)

### ب. الملف: `supabase/functions/tiryak-analytics-ai/index.ts` (إعادة بناء)

**التحسينات:**
- جلب جميع البيانات بدون limit (أو limit أعلى) عندما يطلب المستخدم تحليلاً شاملاً
- إضافة تحليل لكل شهر على حدة (وليس فقط الشهر الحالي)
- إضافة تفاصيل السدادات لكل شركة
- إضافة بيانات الإيرادات حسب الفترات (صباحي/مسائي/ليلي)
- تحسين SYSTEM_PROMPT ليكون أكثر ذكاءً في فهم السياق
- جلب البيانات بشكل ديناميكي حسب ما يطلبه المستخدم

**البيانات الإضافية المتاحة:**
- تفصيل السدادات لكل شركة
- مقارنة شهرية للإيرادات والمصاريف
- تحليل أنماط النواقص
- إجمالي الخدمات البنكية

---

## ملخص الملفات المتأثرة

| الملف | العملية | الوصف |
|-------|---------|-------|
| `src/components/shortage/AddMedicineDialog.tsx` | تعديل | الاسم العلمي إجباري |
| `src/components/payments/CompanySelector.tsx` | تعديل | بحث في الشركات |
| `src/components/payments/PaymentsFilters.tsx` | تعديل | فلاتر شهرية |
| `src/store/paymentsStore.ts` | تعديل | فلترة بالشهر المحدد |
| `src/components/payments/PaymentsList.tsx` | تعديل | نظام صفحات |
| `src/components/payments/CompanyDetailsView.tsx` | **إنشاء** | بطاقة تفصيلية للشركة |
| `src/components/payments/PaymentsManager.tsx` | تعديل | دمج عرض تفاصيل الشركة |
| `src/components/AdminAIAssistant.tsx` | إعادة بناء | جلسات + ذكاء أفضل |
| `supabase/functions/tiryak-analytics-ai/index.ts` | إعادة بناء | بيانات شاملة + تحليل أذكى |

---

## التفاصيل التقنية

### فلتر الشهر الجديد (paymentsStore):

```typescript
interface PaymentsFilters {
  company: string | null;
  showUndeductedOnly: boolean;
  dateFilter: 'all' | 'month';
  selectedMonth: number; // 1-12
  selectedYear: number;  // 2025, 2026, etc.
}
```

### نظام الصفحات (PaymentsList):

```typescript
const PAGE_SIZE = 50;
const [currentPage, setCurrentPage] = useState(1);
const totalPages = Math.ceil(payments.length / PAGE_SIZE);
const paginatedPayments = payments.slice(
  (currentPage - 1) * PAGE_SIZE, 
  currentPage * PAGE_SIZE
);
```

### البوت التحليلي - هيكل الجلسات:

يستخدم جداول `ai_conversations` و `ai_messages` الموجودة بالفعل مع hook `useAIConversations` الجاهز. التغيير الرئيسي هو في واجهة `AdminAIAssistant.tsx` لدمج الجلسات، وفي Edge Function لجلب بيانات أشمل.

### SYSTEM_PROMPT المحسن:

```text
أنت مساعد تحليلي ذكي لصيدلية الترياق الشافي.
- عندما يحييك المستخدم، رد بترحيب ودود واسأل كيف تساعده
- عندما يطلب تحليلاً، استخدم البيانات المتاحة لتقديم تحليل مفصل
- يمكنك مقارنة الأشهر، تحليل أنماط الإنفاق، تتبع النواقص
- قدم اقتراحات عملية بناءً على البيانات
- استخدم جداول وأرقام واضحة في الردود
```
